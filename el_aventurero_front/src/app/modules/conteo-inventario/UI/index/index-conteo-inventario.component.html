<div class="main-container">
  <div class="card">
    <!-- Header -->
    <div class="card-header">
      <h4>Conteo de Inventario</h4>
    </div>

    <div class="card-content">
      <div class="conteo-proceso-alert" *ngIf="conteoEnProceso">
        <div class="alert-warning">
          <i class="pi pi-exclamation-triangle"></i>
          <div class="alert-content">
            <strong>Tienes un conteo sin completar</strong>
            <span>
              Iniciado el {{ conteoEnProceso.fecha | date: "d MMMM yyyy" }}.
              ¿Deseas continuar ese conteo o iniciar uno nuevo?
            </span>
          </div>
          <div class="alert-actions">
            <p-button
              label="Continuar Conteo"
              icon="pi pi-play"
              (click)="continuarConteo()"
              severity="warn"
            ></p-button>
          </div>
        </div>
      </div>

      <!-- Alert - Estado de Conteos -->
      <div
        class="arqueo-dia-alert"
        *ngIf="!conteoEnProceso && getAlertaUltimoConteo() as alerta"
      >
        <!-- SUCCESS -->
        <div class="alert-success" *ngIf="alerta.severity === 'success'">
          <i class="pi pi-check-circle"></i>
          <div class="alert-content">
            <strong>Conteos al día</strong>
            <span>{{ alerta.message }}</span>
          </div>
        </div>

        <!-- WARNING / INFO / DANGER -->
        <div class="alert-warning" *ngIf="alerta.severity !== 'success'">
          <i
            class="pi"
            [ngClass]="{
              'pi-info-circle': alerta.severity === 'info',
              'pi-exclamation-triangle': alerta.severity === 'warning',
              'pi-times-circle': alerta.severity === 'danger',
            }"
          ></i>

          <div class="alert-content">
            <strong>Estado de Conteos</strong>
            <span>{{ alerta.message }}</span>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="p-toolbar mb-4">
        <div class="toolbar-left"></div>

        <div class="toolbar-right">
          <p-button
            label="Realizar Conteo"
            icon="pi pi-plus"
            severity="success"
            (click)="openRealizarConteoModal()"
            class="create-button"
          ></p-button>
        </div>
      </div>

      <!-- Filtros de Fecha -->
      <div class="filtros-fecha">
        <div class="fecha-inputs">
          <div class="campo-fecha">
            <label>Fecha Inicio</label>
            <p-calendar
              appendTo="body"
              [(ngModel)]="fechaInicio"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
            ></p-calendar>
          </div>

          <div class="campo-fecha">
            <label>Fecha Fin</label>
            <p-calendar
              appendTo="body"
              [(ngModel)]="fechaFin"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
            ></p-calendar>
          </div>

          <p-button
            label="Filtrar"
            icon="pi pi-search"
            (click)="cargarDatos()"
          ></p-button>
        </div>

        <div class="fecha-rapida">
          <p-button
            label="Hoy"
            severity="secondary"
            [outlined]="true"
            size="small"
            (click)="aplicarFiltroHoy()"
          ></p-button>

          <p-button
            label="Este Mes"
            severity="secondary"
            [outlined]="true"
            size="small"
            (click)="aplicarFiltroEsteMes()"
          ></p-button>
        </div>
      </div>

      <!-- Tabla de Conteos -->
      <p-table
        [value]="conteos"
        [loading]="loading"
        styleClass="modern-table p-datatable-gridlines"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} conteos"
        [rowsPerPageOptions]="[10, 25, 50]"
        [tableStyle]="{ 'min-width': '50rem' }"
        [scrollable]="true"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th class="text-center">Estado</th>
            <th>Creado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-conteo>
          <tr>
            <td>{{ conteo.fecha | date: "d MMM yyyy" }}</td>
            <td>{{ getTipoLabel(conteo.tipo) }}</td>

            <td class="text-center">
              <p-tag
                [value]="getEstadoLabel(conteo.estado)"
                [severity]="getEstadoSeverity(conteo.estado)"
              ></p-tag>
            </td>

            <td>{{ conteo.created_at | date: "d MMM yyyy, h:mm a" }}</td>

            <td class="text-center">
              <p-button
                icon="pi pi-eye"
                severity="info"
                [text]="true"
                size="small"
                pTooltip="Ver Detalle"
                tooltipPosition="top"
                (click)="openDetalleModal(conteo.id)"
              ></p-button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center empty-message">
              <div class="empty-state">
                <i class="pi pi-inbox empty-icon"></i>
                <h3>No hay conteos registrados</h3>
                <p>No se encontraron conteos en este período.</p>
                <p-button
                  label="Realizar el primero"
                  icon="pi pi-plus"
                  (click)="openRealizarConteoModal()"
                  class="mt-3"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
          <tr>
            <td colspan="5">
              <div class="loading-state">
                <i class="pi pi-spin pi-spinner loading-spinner"></i>
                <span>Cargando conteos...</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<app-detalle-conteo
  [displayModal]="showDetalleModal"
  [conteoId]="conteoIdSeleccionado"
  (modalClosed)="onDetalleModalClosed()"
>
</app-detalle-conteo>

<!-- Modal Realizar Conteo -->
<app-realizar-conteo
  [displayModal]="showRealizarConteoModal"
  [conteoId]="conteoIdSeleccionado"
  (modalClosed)="onRealizarConteoModalClosed()"
>
</app-realizar-conteo>

<p-toast></p-toast>
<p-confirmDialog styleClass="modern-confirm-dialog"></p-confirmDialog>
