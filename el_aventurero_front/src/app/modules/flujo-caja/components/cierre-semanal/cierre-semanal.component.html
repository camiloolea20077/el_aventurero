<p-dialog
  header="Cierre Semanal"
  [(visible)]="displayModal"
  [modal]="true"
  [style]="{ width: '95vw', maxWidth: '1400px' }"
  [draggable]="false"
  [resizable]="false"
  (onHide)="onModalHide()"
  styleClass="modern-dialog cierre-semanal-dialog"
>
  <div class="cierre-container">
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <i class="pi pi-spin pi-spinner loading-spinner"></i>
      <span>Generando cierre semanal...</span>
    </div>

    <!-- Contenido del Cierre -->
    <div *ngIf="!loading && cierre" class="cierre-content">
      <!-- Header -->
      <div class="cierre-header">
        <div class="header-info">
          <h2 class="semana-title">Semana {{ cierre.semana }}</h2>
          <p class="periodo">
            {{ cierre.fecha_inicio | date: "d MMM" }} -
            {{ cierre.fecha_fin | date: "d MMM yyyy" }}
          </p>
        </div>
      </div>

      <!-- Resumen Financiero -->
      <div class="resumen-financiero">
        <h3 class="section-title">
          <i class="pi pi-chart-line"></i>
          Resumen Financiero
        </h3>

        <div class="cards-grid">
          <div class="summary-card ventas">
            <div class="card-icon">
              <i class="pi pi-shopping-cart"></i>
            </div>
            <div class="card-content">
              <span class="card-label">Ventas Totales</span>
              <span class="card-value"
                >${{ cierre.ventas_totales | number: "1.0-0" }}</span
              >
              <span class="card-detail"
                >{{ cierre.cantidad_ventas }} ventas</span
              >
            </div>
          </div>

          <div class="summary-card ingresos">
            <div class="card-icon">
              <i class="pi pi-arrow-circle-up"></i>
            </div>
            <div class="card-content">
              <span class="card-label">Total Ingresos</span>
              <span class="card-value"
                >${{ cierre.total_ingresos | number: "1.0-0" }}</span
              >
            </div>
          </div>

          <div class="summary-card egresos">
            <div class="card-icon">
              <i class="pi pi-arrow-circle-down"></i>
            </div>
            <div class="card-content">
              <span class="card-label">Total Egresos</span>
              <span class="card-value"
                >${{ cierre.total_egresos | number: "1.0-0" }}</span
              >
            </div>
          </div>

          <div class="summary-card balance">
            <div class="card-icon">
              <i class="pi pi-wallet"></i>
            </div>
            <div class="card-content">
              <span class="card-label">Balance Neto</span>
              <span class="card-value"
                >${{ cierre.balance_neto | number: "1.0-0" }}</span
              >
            </div>
          </div>

          <div class="summary-card ticket">
            <div class="card-icon">
              <i class="pi pi-receipt"></i>
            </div>
            <div class="card-content">
              <span class="card-label">Ticket Promedio</span>
              <span class="card-value"
                >${{ cierre.ticket_promedio | number: "1.0-0" }}</span
              >
            </div>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Sección de Control de Arqueos -->
      <div class="control-arqueos-section" *ngIf="cierre?.resumen_arqueos">
        <h3 class="section-title">
          <i class="pi pi-shield"></i>
          Control de Arqueos
        </h3>

        <!-- Grid de Estadísticas -->
        <div class="arqueos-stats-grid">
          <div class="stat-card dias">
            <div class="stat-icon">
              <i class="pi pi-calendar"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">Total de Días</span>
              <span class="stat-value">{{
                cierre.resumen_arqueos.total_dias
              }}</span>
            </div>
          </div>

          <div class="stat-card realizados">
            <div class="stat-icon">
              <i class="pi pi-check-circle"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">Arqueos Realizados</span>
              <span class="stat-value">
                {{ cierre.resumen_arqueos.arqueos_realizados }} /
                {{ cierre.resumen_arqueos.total_dias }}
              </span>
            </div>
          </div>

          <div class="stat-card cuadrados">
            <div class="stat-icon">
              <i class="pi pi-check"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">Cuadrados</span>
              <span class="stat-value">{{
                cierre.resumen_arqueos.arqueos_cuadrados
              }}</span>
            </div>
          </div>

          <div
            class="stat-card pendientes"
            *ngIf="cierre.resumen_arqueos.arqueos_pendientes > 0"
          >
            <div class="stat-icon warning">
              <i class="pi pi-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">Pendientes</span>
              <span class="stat-value">{{
                cierre.resumen_arqueos.arqueos_pendientes
              }}</span>
            </div>
          </div>

          <div
            class="stat-card ajustados"
            *ngIf="cierre.resumen_arqueos.arqueos_ajustados > 0"
          >
            <div class="stat-icon">
              <i class="pi pi-wrench"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">Ajustados</span>
              <span class="stat-value">{{
                cierre.resumen_arqueos.arqueos_ajustados
              }}</span>
            </div>
          </div>
        </div>

        <!-- Resumen de Diferencias -->
        <div class="diferencias-resumen">
          <div class="diferencias-card">
            <h4 class="card-title">Análisis de Diferencias</h4>

            <div class="diferencias-grid">
              <div class="diferencia-item sobrantes">
                <div class="diferencia-header">
                  <i class="pi pi-arrow-up"></i>
                  <span class="diferencia-label">Sobrantes</span>
                </div>
                <span class="diferencia-valor">
                  +${{
                    cierre.resumen_arqueos.total_sobrantes | number: "1.0-0"
                  }}
                </span>
              </div>

              <div class="diferencia-item faltantes">
                <div class="diferencia-header">
                  <i class="pi pi-arrow-down"></i>
                  <span class="diferencia-label">Faltantes</span>
                </div>
                <span class="diferencia-valor">
                  -${{
                    cierre.resumen_arqueos.total_faltantes | number: "1.0-0"
                  }}
                </span>
              </div>

              <div
                class="diferencia-item total"
                [class.positivo]="cierre.resumen_arqueos.total_diferencias > 0"
                [class.negativo]="cierre.resumen_arqueos.total_diferencias < 0"
                [class.cero]="cierre.resumen_arqueos.total_diferencias === 0"
              >
                <div class="diferencia-header">
                  <i class="pi pi-calculator"></i>
                  <span class="diferencia-label">Balance de Diferencias</span>
                </div>
                <span class="diferencia-valor">
                  {{
                    cierre.resumen_arqueos.total_diferencias >= 0 ? "+" : ""
                  }}${{
                    cierre.resumen_arqueos.total_diferencias | number: "1.0-0"
                  }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Alerta si faltan arqueos -->
        <div
          class="alert-arqueos"
          *ngIf="
            cierre.resumen_arqueos.arqueos_realizados <
            cierre.resumen_arqueos.total_dias
          "
        >
          <div class="alert-content warning">
            <i class="pi pi-exclamation-triangle"></i>
            <div class="alert-text">
              <strong>¡Atención!</strong>
              <span>
                Faltan
                {{
                  cierre.resumen_arqueos.total_dias -
                    cierre.resumen_arqueos.arqueos_realizados
                }}
                arqueo(s) por realizar en este período.
              </span>
            </div>
          </div>
        </div>

        <!-- Alerta si hay pendientes -->
        <div
          class="alert-arqueos"
          *ngIf="cierre.resumen_arqueos.arqueos_pendientes > 0"
        >
          <div class="alert-content danger">
            <i class="pi pi-times-circle"></i>
            <div class="alert-text">
              <strong>Diferencias sin justificar</strong>
              <span>
                Hay {{ cierre.resumen_arqueos.arqueos_pendientes }} arqueo(s)
                con diferencias pendientes de justificar. Total sin justificar:
                <strong>
                  {{
                    cierre.resumen_arqueos.total_diferencias >= 0 ? "+" : ""
                  }}${{
                    cierre.resumen_arqueos.total_diferencias | number: "1.0-0"
                  }}
                </strong>
              </span>
            </div>
          </div>
        </div>

        <!-- Mensaje de éxito si todo está bien -->
        <div
          class="alert-arqueos"
          *ngIf="
            cierre.resumen_arqueos.arqueos_realizados ===
              cierre.resumen_arqueos.total_dias &&
            cierre.resumen_arqueos.arqueos_pendientes === 0
          "
        >
          <div class="alert-content success">
            <i class="pi pi-check-circle"></i>
            <div class="alert-text">
              <strong>¡Excelente!</strong>
              <span> Todos los arqueos están completos y justificados. </span>
            </div>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Métodos de Pago -->
      <div class="metodos-pago-section">
        <h3 class="section-title">
          <i class="pi pi-credit-card"></i>
          Métodos de Pago
        </h3>

        <div class="metodos-grid">
          <div class="metodo-card" *ngFor="let metodo of cierre.metodos_pago">
            <div class="metodo-header">
              <i
                class="pi"
                [ngClass]="{
                  'pi-money-bill': metodo.metodo === 'EFECTIVO',
                  'pi-credit-card': metodo.metodo === 'TARJETA',
                  'pi-arrow-right-arrow-left':
                    metodo.metodo === 'TRANSFERENCIA',
                  'pi-mobile': metodo.metodo === 'DIGITAL',
                }"
              ></i>
              <span class="metodo-nombre">{{ metodo.metodo }}</span>
            </div>
            <div class="metodo-stats">
              <div class="stat">
                <span class="stat-label">Cantidad</span>
                <span class="stat-value">{{ metodo.cantidad }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Total</span>
                <span class="stat-value"
                  >${{ metodo.total | number: "1.0-0" }}</span
                >
              </div>
              <div class="stat">
                <span class="stat-label">Porcentaje</span>
                <span class="stat-value"
                  >{{ metodo.porcentaje | number: "1.1-1" }}%</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Productos Top -->
      <div class="productos-top-section">
        <h3 class="section-title">
          <i class="pi pi-star-fill"></i>
          Top 5 Productos Más Vendidos
        </h3>

        <div class="productos-table">
          <div class="table-header">
            <span class="col-posicion">#</span>
            <span class="col-producto">Producto</span>
            <span class="col-cantidad">Cantidad</span>
            <span class="col-total">Total Vendido</span>
          </div>
          <div
            class="table-row"
            *ngFor="let producto of cierre.productos_top; let i = index"
          >
            <span class="col-posicion">
              <div class="posicion-badge" [class]="'pos-' + (i + 1)">
                {{ i + 1 }}
              </div>
            </span>
            <span class="col-producto">{{ producto.producto_nombre }}</span>
            <span class="col-cantidad"
              >{{ producto.cantidad_vendida }} unidades</span
            >
            <span class="col-total"
              >${{ producto.total_vendido | number: "1.0-0" }}</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button
        label="Cerrar"
        icon="pi pi-times"
        (onClick)="closeModal()"
        severity="secondary"
        [outlined]="true"
      ></p-button>
      <p-button
        label="Descargar PDF"
        icon="pi pi-file-pdf"
        severity="danger"
        [outlined]="true"
      ></p-button>
      <p-button
        label="Exportar Excel"
        icon="pi pi-file-excel"
        severity="success"
        [outlined]="true"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
