<div class="main-container">
  <div class="card">
    <!-- Header -->
    <div class="card-header">
      <h4>
        <i class="pi pi-table"></i>
        Gestión de Mesas
      </h4>
    </div>

    <div class="card-content">
      <!-- Loading -->
      <div *ngIf="loading" class="loading-state">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Cargando mesas...</span>
      </div>

      <!-- Grid de Mesas -->
      <div *ngIf="!loading" class="mesas-grid flex flex-wrap gap-3">
        <div
          *ngFor="let mesa of mesas"
          class="mesa-card"
          [ngClass]="getMesaClass(mesa)"
          (click)="abrirMesa(mesa)"
        >
          <div class="mesa-numero">{{ mesa.numero }}</div>
          <div class="mesa-estado">
            <i [class]="getMesaIcon(mesa)"></i>
            {{ mesa.estado }}
          </div>
          <div class="mesa-total">
            ${{
              mesa.total_acumulado ? mesa.total_acumulado.toLocaleString() : "0"
            }}
          </div>
        </div>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="!loading && mesas.length === 0" class="empty-state">
        <i class="pi pi-inbox empty-icon"></i>
        <h3>No hay mesas registradas</h3>
        <p>Cree mesas para comenzar a gestionar pedidos</p>
      </div>
    </div>
  </div>
</div>

<!-- Dialog de Consumo -->
<p-dialog
  [(visible)]="displayConsumoDialog"
  [header]="'Mesa ' + mesaSeleccionada?.numero"
  [modal]="true"
  [style]="{ width: '700px' }"
  [draggable]="false"
  [resizable]="false"
  (onHide)="cerrarDialog()"
  styleClass="consumo-dialog"
>
  <div class="consumo-container" *ngIf="mesaSeleccionada">
    <!-- Agregar Producto -->
    <div class="add-producto-section">
      <h5>
        <i class="pi pi-plus-circle"></i>
        Agregar Producto
      </h5>

      <div class="add-producto-form">
        <div class="form-row">
          <div class="form-field flex-1">
            <label>Producto</label>
            <p-dropdown
              [(ngModel)]="productoSeleccionado"
              [options]="productos"
              optionLabel="nombre"
              placeholder="Seleccione un producto"
              [filter]="true"
              filterPlaceholder="Buscar producto..."
              [showClear]="true"
              styleClass="w-full"
            >
              <ng-template let-producto pTemplate="item">
                <div class="producto-option">
                  <span class="nombre">{{ producto.nombre }}</span>
                  <span class="tipo">{{ producto.tipo_venta }}</span>
                </div>
              </ng-template>
            </p-dropdown>
          </div>

          <div class="form-field">
            <label>Cantidad</label>
            <p-inputNumber
              [(ngModel)]="cantidad"
              [min]="1"
              [showButtons]="true"
              buttonLayout="horizontal"
              spinnerMode="horizontal"
              decrementButtonClass="p-button-secondary"
              incrementButtonClass="p-button-secondary"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              styleClass="cantidad-input"
            ></p-inputNumber>
          </div>

          <div class="form-field">
            <label>&nbsp;</label>
            <p-button
              label="Agregar"
              icon="pi pi-plus"
              (onClick)="agregarProducto()"
              severity="warn"
              styleClass="add-button"
            ></p-button>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Lista de Consumos -->
    <div class="consumos-section">
      <div class="section-header">
        <h5>
          <i class="pi pi-list"></i>
          Productos en la Mesa
        </h5>
        <div class="total-mesa">
          Total: <strong>${{ totalMesa.toLocaleString() }}</strong>
        </div>
      </div>

      <!-- Loading consumos -->
      <div *ngIf="loadingConsumo" class="loading-small">
        <i class="pi pi-spin pi-spinner"></i>
        Cargando...
      </div>

      <!-- Lista de consumos -->
      <div *ngIf="!loadingConsumo" class="consumos-list">
        <div *ngFor="let consumo of consumos" class="consumo-item">
          <div class="consumo-info">
            <div class="producto-nombre">
              {{ consumo.producto_nombre }}
            </div>
            <div class="producto-detalle">
              {{ consumo.cantidad }} x ${{
                consumo.precio_unitario.toLocaleString()
              }}
            </div>
          </div>
          <div class="consumo-actions">
            <div class="subtotal">${{ consumo.subtotal.toLocaleString() }}</div>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [text]="true"
              [rounded]="true"
              size="small"
              (onClick)="eliminarConsumo(consumo)"
              pTooltip="Eliminar"
            ></p-button>
          </div>
        </div>

        <!-- Sin consumos -->
        <div *ngIf="consumos.length === 0" class="sin-consumos">
          <i class="pi pi-inbox"></i>
          <p>No hay productos en esta mesa</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer con acciones -->
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <div class="metodo-pago gap-3 flex">
        <label>Método de Pago:</label>
        <p-dropdown
          [(ngModel)]="metodoPagoSeleccionado"
          [options]="metodosPago"
          optionLabel="label"
          optionValue="value"
          styleClass="metodo-dropdown"
        ></p-dropdown>
      </div>

      <div class="footer-actions mt-3 gap-3 flex">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          (onClick)="cerrarDialog()"
          severity="danger"
          [outlined]="true"
        ></p-button>
        <p-button
          label="Cerrar Cuenta"
          icon="pi pi-check"
          (onClick)="cerrarCuenta()"
          severity="warn"
          [disabled]="consumos.length === 0"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
