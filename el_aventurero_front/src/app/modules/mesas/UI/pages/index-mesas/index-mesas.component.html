<div class="page-container">
  <div class="flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">MESAS - EL AVENTURERO</h1>
    <div class="flex gap-2">
      <p-button
        label="Administrar Mesas"
        icon="pi pi-cog"
        class="btn-ghost"
        (onClick)="showAdminDialog()"
      >
      </p-button>
    </div>
  </div>

  <!-- Vista de Mesas en Grid -->
  <div class="mesas-grid">
    <div
      *ngFor="let mesa of mesas"
      class="mesa-card"
      [ngClass]="{
        'mesa-libre': mesa.estado === 'LIBRE',
        'mesa-ocupada': mesa.estado === 'OCUPADA',
      }"
      (click)="abrirMesa(mesa)"
    >
      <div class="mesa-numero">{{ mesa.numero }}</div>
      <div class="mesa-estado">
        <i
          [class]="
            mesa.estado === 'LIBRE' ? 'pi pi-check-circle' : 'pi pi-clock'
          "
        ></i>
        {{ mesa.estado }}
      </div>
      <div class="mesa-total" *ngIf="mesa.estado === 'OCUPADA'">
        {{ mesa.total_acumulado | currency: "COP" : "symbol-narrow" : "1.0-0" }}
      </div>
    </div>
  </div>
</div>

<!-- Dialog de Consumo de Mesa -->
<p-dialog
  [header]="'Mesa ' + mesaSeleccionada?.numero"
  [(visible)]="displayConsumoDialog"
  [modal]="true"
  [style]="{ width: '800px', maxWidth: '95vw' }"
  [maximizable]="true"
>
  <div class="consumo-container" *ngIf="mesaSeleccionada">
    <!-- Header con estado -->
    <div class="flex justify-content-between align-items-center mb-4">
      <div>
        <span
          [class]="
            mesaSeleccionada.estado === 'LIBRE'
              ? 'badge-libre'
              : 'badge-ocupada'
          "
        >
          {{ mesaSeleccionada.estado }}
        </span>
      </div>
      <div class="total-mesa">
        Total:
        <strong>{{
          calcularTotal() | currency: "COP" : "symbol-narrow" : "1.0-0"
        }}</strong>
      </div>
    </div>

    <!-- Formulario para agregar productos -->
    <p-card
      styleClass="gold-card mb-3"
      *ngIf="mesaSeleccionada.estado === 'OCUPADA' || consumos.length === 0"
    >
      <div class="section-title">Agregar Producto</div>
      <form
        [formGroup]="consumoForm"
        (ngSubmit)="agregarProducto()"
        class="flex flex-column gap-3"
      >
        <div class="grid">
          <div class="col-12 md:col-6">
            <label class="field-label">Producto</label>
            <p-dropdown
              appendTo="body"
              formControlName="producto_id"
              [options]="productos"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Selecciona producto"
              styleClass="w-full"
              [filter]="true"
            >
            </p-dropdown>
          </div>

          <div class="col-12 md:col-3">
            <label class="field-label">Cantidad</label>
            <p-inputNumber
              formControlName="cantidad"
              [min]="1"
              [showButtons]="true"
              styleClass="w-full"
            >
            </p-inputNumber>
          </div>

          <div class="col-12 md:col-3 flex align-items-end">
            <p-button
              label="Agregar"
              icon="pi pi-plus"
              class="btn-gold w-full"
              type="submit"
              [disabled]="consumoForm.invalid"
            >
            </p-button>
          </div>
        </div>
      </form>
    </p-card>

    <!-- Lista de consumos -->
    <p-card styleClass="gold-card">
      <div class="section-title">Productos Consumidos</div>

      <div class="consumos-list" *ngIf="consumos.length > 0; else noConsumos">
        <div
          class="consumo-item"
          *ngFor="let consumo of consumos; let i = index"
        >
          <div class="flex justify-content-between align-items-center">
            <div class="flex-1">
              <div class="producto-nombre">
                {{
                  consumo.producto?.nombre || "Producto " + consumo.producto_id
                }}
              </div>
              <div class="producto-detalle">
                {{ consumo.cantidad }} x
                {{
                  consumo.precio_unitario
                    | currency: "COP" : "symbol-narrow" : "1.0-0"
                }}
              </div>
            </div>
            <div class="flex align-items-center gap-3">
              <div class="subtotal">
                {{
                  consumo.subtotal | currency: "COP" : "symbol-narrow" : "1.0-0"
                }}
              </div>
              <p-button
                icon="pi pi-trash"
                class="btn-danger"
                [rounded]="true"
                [text]="true"
                severity="danger"
                (onClick)="eliminarConsumo(i)"
              >
              </p-button>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noConsumos>
        <div class="text-center p-4" style="color: var(--muted)">
          <i class="pi pi-inbox" style="font-size: 2rem; opacity: 0.5"></i>
          <p class="mt-2">No hay productos consumidos aún</p>
        </div>
      </ng-template>
    </p-card>

    <!-- Acciones -->
    <div
      class="flex gap-2 justify-content-end mt-4"
      *ngIf="consumos.length > 0"
    >
      <p-button
        label="Cerrar Cuenta"
        icon="pi pi-check"
        class="btn-success"
        (onClick)="cerrarCuenta()"
      >
      </p-button>
    </div>
  </div>
</p-dialog>

<!-- Dialog Administrar Mesas -->
<p-dialog
  header="Administrar Mesas"
  [(visible)]="displayAdminDialog"
  [modal]="true"
  [style]="{ width: '600px' }"
>
  <div class="flex justify-content-end mb-3">
    <p-button
      label="Nueva Mesa"
      icon="pi pi-plus"
      class="btn-gold"
      (onClick)="showMesaForm()"
    >
    </p-button>
  </div>

  <p-table [value]="mesas" styleClass="p-datatable-sm">
    <ng-template pTemplate="header">
      <tr>
        <th>Número</th>
        <th>Estado</th>
        <th>Total</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-mesa>
      <tr>
        <td>Mesa {{ mesa.numero }}</td>
        <td>
          <span
            [class]="mesa.estado === 'LIBRE' ? 'badge-libre' : 'badge-ocupada'"
          >
            {{ mesa.estado }}
          </span>
        </td>
        <td>
          {{
            mesa.total_acumulado | currency: "COP" : "symbol-narrow" : "1.0-0"
          }}
        </td>
        <td>
          <div class="flex gap-2">
            <p-button
              icon="pi pi-pencil"
              class="btn-ghost"
              [rounded]="true"
              [text]="true"
              (onClick)="editMesa(mesa)"
            >
            </p-button>
            <p-button
              icon="pi pi-trash"
              class="btn-danger"
              [rounded]="true"
              [text]="true"
              (onClick)="deleteMesa(mesa.id)"
            >
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<!-- Dialog Crear/Editar Mesa -->
<p-dialog
  [header]="editModeMesa ? 'Editar Mesa' : 'Nueva Mesa'"
  [(visible)]="displayMesaFormDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
>
  <form [formGroup]="mesaForm" (ngSubmit)="saveMesa()">
    <div class="flex flex-column gap-3">
      <div class="flex flex-column gap-2">
        <label class="field-label">Número de Mesa</label>
        <input
          pInputText
          formControlName="numero"
          type="number"
          placeholder="Ej: 1"
        />
      </div>

      <div class="flex gap-2 justify-content-end mt-3">
        <p-button
          label="Cancelar"
          class="btn-ghost"
          type="button"
          (onClick)="displayMesaFormDialog = false"
        >
        </p-button>
        <p-button
          label="Guardar"
          class="btn-gold"
          type="submit"
          [disabled]="mesaForm.invalid"
        >
        </p-button>
      </div>
    </div>
  </form>
</p-dialog>

<p-toast></p-toast>
